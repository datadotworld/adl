<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <style>
        .active { fill: blue !important;}
        /*.datamaps-key dt, .datamaps-key dd {float: none !important;}
        .datamaps-key {right: -50px; top: 0;}*/
    </style>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' />
</head>
<body>

<div class="container">
  <div class="panel panel-default">
    <div class="panel-heading">    Hate crimes reported per capita in 2015, &amp; cities that did not report or reported 0
  </div>
    <div class="panel-body">
      <div id="container1" style="width: 100%; height: 100vh; max-height: 700px; position: relative;"></div>
    </div>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.14/d3.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datamaps/0.5.8/datamaps.all.hires.js"></script>
<script>
    // static data
    d3.csv('normalized_state_crime.csv', function (err, data) {

    var valuesByState = {}
    var values = data.forEach(function(data) {
      valuesByState[data.Code] = parseFloat(data.Normalized)
    })

    var dataset = {};

    // We need to colorize every country based on "numberOfWhatever"
    // colors should be uniq for every value.
    // For this purpose we create palette(using min/max series-value)
    var onlyValues = Object.keys(valuesByState).map(function(key){ return valuesByState[key] });
    var minValue = Math.min.apply(null, onlyValues),
            maxValue = Math.max.apply(null, onlyValues);

    // create color palette function
    // color can be whatever you wish
    var paletteScale = d3.scale.linear()
            .domain([minValue,maxValue])
            .range(["#EFEFFF","#02386F"]); // blue color

    // fill dataset in appropriate format
    Object.keys(valuesByState).forEach(function(key){ //
        // item example value ["USA", 70]
        var iso = key,
                value = valuesByState[key];
        dataset[iso] = { numberOfThings: value, fillColor: paletteScale(value) };
    });

    var map = new Datamap({
        element: document.getElementById('container1'),
        scope: 'usa',
        fills: { defaultFill: '#00B88D' },
        data: dataset,
        geographyConfig: {
            borderColor: '#DEDEDE',
            highlightBorderWidth: 1,
            popupOnHover: false,
            highlightFillColor: function(geo) {
                return geo['fillColor'] || '#F5F5F5';
            },
        }
    });

    d3.csv('dnr.csv', function (err, data) {
      var scale = d3.scale.linear()
        .domain([100000, 999307])
        .range([5, 25])

      var bubbles = data.map(function(item) {
        return {
          latitude: parseFloat(item.Latitude),
          longitude: parseFloat(item.Longitude),
          name: item.City + '<br/>Population: ' + numberWithCommas(item.Population) + '<br/>Reported 0 or no hate crimes in 2015.',

          radius: scale(item.Population)
        }
      })

      map.bubbles(bubbles)
  })
})

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

</script>

</body>
</html>
